# Plan Workflow

本文件用于 Plan 阶段的工作流。

---

## 1. 触发条件

- 未指定任务 id 或任务文件路径时，进入 Plan 阶段。

---

## 2. 输出与确认

### 2.1 澄清与出方案许可
- 多轮澄清后，AI 必须询问“是否可以出方案”；未获确认不得输出方案草稿

### 2.2 草稿方案（简化版，不落盘）
- 输出简化方案（目标/范围/非范围/风险与约束/验收要点/可能涉及目录范围），仅对话输出，不写入 `tasks/`

### 2.3 迭代补充
- 用户提出“补充/调整/追加”时，仅提示与上一版方案的差异点，不新建任务、不落盘

### 2.4 用户确认（落盘）
- 用户明确“创建/落盘/立项/任务单/创建任务/新任务”等关键字后才允许落盘；确认前不写入 `tasks/todos.json`

### 2.5 最终确认
- 落盘后允许补充/调整当前任务文档（仍需提示差异点）；用户明确“最终确认/开始执行”后进入执行阶段（Runner）

---

## 3. 落盘（确认后）

1) 创建 `tasks/items/{id}.md`（结构使用 `references/templates/000-task-example.md`，生成详细版本计划）
2) 创建 `tasks/logs/tasks/{id}.log`
3) 在 `tasks/todos.json` 中新增条目（`status: todo`）
4) 提示用户任务已落盘（含路径），可继续补充/调整

---

## 4. 写入范围

- 允许写入：
  - `tasks/items/{id}.md`
  - `tasks/logs/tasks/{id}.log`
  - `tasks/todos.json`

- 不允许写入：
  - 业务代码
  - 其他任务文件
